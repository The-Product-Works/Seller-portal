# Changes Made on December 11, 2025

## üéØ Summary
Fixed critical bundle stock calculation bugs and added FSSAI certificate upload functionality to KYC system.

---

## üîß Bug Fixes

### 1. **Bundle Stock Calculation System - MAJOR FIX**

**Problem:**
- Bundles were showing incorrect stock quantities in Dashboard and Inventory
- Dashboard was incorrectly **adding up** product stocks instead of calculating minimum possible bundles
- Inventory was using stale database values
- Bundle restock dialog only updated database column but didn't actually restock products
- Example bug: Bundle needs 2√óProduct A (10 stock) + 1√óProduct B (3 stock)
  - ‚ùå OLD: Showed 23 bundles (10√ó2 + 3√ó1 = 23)
  - ‚úÖ NEW: Shows 3 bundles (min(10/2, 3/1) = min(5, 3) = 3)

**Files Modified:**
1. `src/pages/Inventory.tsx`
   - Added `total_stock_quantity` to bundle query
   - Calculate bundle stock dynamically: `Math.min(...possibleBundles)` where possibleBundles = productStock / requiredPerBundle
   - Bundle stock now reflects actual number of complete bundles that can be made

2. `src/pages/Dashboard.tsx`
   - Fixed `loadBundles()` function to calculate stock correctly
   - Fixed `loadLowStockBundles()` to use calculated stock and filter client-side
   - Changed from summing products to finding minimum possible bundles

3. `src/components/DashboardProductStock.tsx`
   - Added `bundle_items` with product stock to query
   - Calculate bundle stock dynamically in forEach loop
   - Low stock detection now uses calculated stock

4. `src/components/BundleRestockDialog.tsx` - **CRITICAL FIX**
   - **Complete rewrite** of bundle restocking logic
   - Now fetches bundle items and updates **actual product stocks**
   - When restocking bundle by N units, increases each product stock by N √ó required_per_bundle
   - Example: Restock bundle by 5, bundle needs 2√óA + 1√óB ‚Üí A increases by 10, B increases by 5
   - Bundle stock automatically reflects new calculated value

**Impact:**
- ‚úÖ Accurate bundle stock display everywhere
- ‚úÖ Bundle restocking actually works now
- ‚úÖ Inventory shows all bundles including 0 stock
- ‚úÖ Dashboard and Inventory always in sync
- ‚úÖ Low stock notifications work correctly

---

## ‚ú® New Features

### 2. **FSSAI Certificate Upload to KYC**

**Requirement:**
- Sellers need to upload FSSAI license certificate (PDF or image) in addition to FSSAI number
- Certificate is mandatory for KYC completion
- Must support both PDF and image formats

**Implementation:**

#### Database Changes:
**File:** `supabase/migrations/20251211_add_fssai_certificate.sql`
```sql
-- Added column to sellers table
ALTER TABLE sellers ADD COLUMN fssai_certificate_url TEXT;

-- Updated seller_documents doc_type constraint
ALTER TABLE seller_documents 
ADD CONSTRAINT seller_documents_doc_type_check 
CHECK (doc_type IN ('selfie', 'aadhaar', 'pan', 'gstin', 'fssai_certificate'));
```

#### Frontend Changes:

**File:** `src/types/seller.types.ts`
- Added `"fssai_certificate"` to `DocumentType` union type

**File:** `src/lib/validations/document.schema.ts`
- Added `"fssai_certificate"` to document type schema enum
- Already supports PDF files via `ALLOWED_DOCUMENT_TYPES`

**File:** `src/pages/KYC.tsx`
- Added `fssaiCertificate` state: `useState<File | null>(null)`
- Added `fssai_certificate` to `uploadedDocuments` interface
- Load existing FSSAI certificate from `seller_documents` table
- Upload FSSAI certificate for new sellers
- Upload FSSAI certificate for existing sellers during resubmission
- Added UI component with:
  - File input accepting `image/*,application/pdf`
  - Preview for uploaded files showing filename, size, type
  - Link to view previously uploaded certificate
  - Remove button (X icon)
  - Required field validation
  - Max 10MB file size (enforced by existing validation)

**User Experience:**
1. Seller enters FSSAI license number and expiry date
2. Seller uploads FSSAI certificate (PDF or image)
3. Certificate is stored in `seller_details` bucket under `{seller_id}/fssai_certificate/{timestamp}_{filename}`
4. Signed URL (valid 100 years) stored in `seller_documents` table
5. Certificate can be viewed/downloaded later from KYC page

---

## üìÅ Files Changed

### Modified Files:
1. `src/pages/Inventory.tsx` - Bundle stock calculation
2. `src/pages/Dashboard.tsx` - Bundle stock calculation
3. `src/components/DashboardProductStock.tsx` - Bundle stock calculation
4. `src/components/BundleRestockDialog.tsx` - Complete rewrite of restock logic
5. `src/pages/KYC.tsx` - FSSAI certificate upload
6. `src/types/seller.types.ts` - Added fssai_certificate type
7. `src/lib/validations/document.schema.ts` - Added fssai_certificate to schema

### New Files:
1. `supabase/migrations/20251211_add_fssai_certificate.sql` - Database migration for FSSAI certificate

---

## üß™ Testing Checklist

### Bundle Stock:
- [ ] Create bundle with 2 products
- [ ] Check stock shows correct minimum in Dashboard
- [ ] Check stock shows correct minimum in Inventory
- [ ] Restock a product ‚Üí bundle stock increases automatically
- [ ] Use bundle restock dialog ‚Üí product stocks increase proportionally
- [ ] Verify bundle with 0 stock shows in Inventory
- [ ] Low stock notification appears when bundle ‚â§ 10

### FSSAI Certificate:
- [ ] New seller: Upload PDF certificate ‚Üí saves successfully
- [ ] New seller: Upload image certificate ‚Üí saves successfully
- [ ] View uploaded certificate ‚Üí link opens in new tab
- [ ] Existing seller: Upload new certificate ‚Üí replaces old one
- [ ] Try uploading >10MB file ‚Üí validation error
- [ ] Try uploading unsupported format ‚Üí validation error
- [ ] Submit without certificate ‚Üí validation error

---

## üöÄ Deployment Steps

1. **Run Database Migration:**
   ```bash
   # Connect to Supabase and run:
   supabase migration up
   # Or apply manually via Supabase dashboard SQL editor
   ```

2. **Deploy Frontend:**
   ```bash
   npm run build
   # Deploy dist/ folder to hosting
   ```

3. **Verify:**
   - Check sellers table has `fssai_certificate_url` column
   - Check seller_documents table accepts 'fssai_certificate' doc_type
   - Test bundle stock calculations
   - Test FSSAI certificate upload

---

## üí° Technical Notes

### Bundle Stock Algorithm:
```typescript
// For each bundle item:
const possibleBundles = bundleItems.map(item => {
  const productStock = item.seller_product_listings.total_stock_quantity;
  const requiredPerBundle = item.quantity;
  return Math.floor(productStock / requiredPerBundle);
});

// Bundle stock = minimum of all possible bundles
const bundleStock = Math.min(...possibleBundles);
```

### Bundle Restock Algorithm:
```typescript
// When restocking bundle by N units:
for (const item of bundleItems) {
  const stockToAdd = N * item.quantity;
  const newProductStock = currentProductStock + stockToAdd;
  // Update product stock in seller_product_listings
}
```

### FSSAI Certificate Storage:
- **Bucket:** `seller_details`
- **Path:** `{seller_id}/fssai_certificate/{timestamp}_{filename}`
- **Table:** `seller_documents` with doc_type = 'fssai_certificate'
- **Signed URL:** Valid for 100 years
- **Max Size:** 10MB
- **Formats:** PDF, JPEG, PNG, WebP

---

## ‚ö†Ô∏è Breaking Changes

**None** - All changes are backward compatible. Existing bundles and documents continue to work.

---

## üìù Known Issues

**None** - All ESLint errors are style warnings (inline styles), not functional issues.

---

## üë• Credits

- Bundle stock calculation algorithm
- FSSAI certificate upload system
- Bundle restock dialog rewrite
- Documentation

---

## üìÖ Date: December 11, 2025
